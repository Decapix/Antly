{% extends "index.html" %} {% load static %} {% block head %}
<script src="https://js.stripe.com/v3/"></script>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>
{% endblock %} {% block content %}
<div class="if_hidden">{% include "space.html" %}</div>
<section class="section" id="about">
  <div class="container">
    <div class="if_hidden">
      <h2 class="mb-3">Ma commande</h2>
    </div>
  </div>
</section>

<section class="section" id="blog">
  <div class="container">
    <div class="row justify-content-between">
      <div class="col-md-8 pr-md-5 mb-4 mb-md-0">
        <div class="mb-5">
          <h4>Résumé de la commande</h4>
          <table class="table table-striped">
            <tbody>
              {% for item in order.get_cart_items %}
              <tr>
                <td>{{ item.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.price }} €</td>
              </tr>
              {% endfor %}
              <tr>
                <td>Transport</td>
                <td></td>
                <td>{{ order.shipping_costs }} €</td>
              </tr>

              {% if order.gift %}
              <td>Colonie offerte</td>
              <td>1</td>
              <td>0 €</td>
              {% endif %}
            </tbody>

            <tfoot>
              <tr>
                <th scope="col">Total de la commande</th>
                <th scope="col">{{ order.get_cart_total }} €</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <!-- strip-->
        <h4 class="mb-4">Paiement</h4>
        <!-- Affichez ici le formulaire de paiement Stripe -->


        <!-- endstrip-->
      </div>

      <div class="col-md-4 pl-md-5">
        <!-- adress-->
        <h4>Adresse de livraison</h4>

        <div class="">
          <div class="">
            <form id="new-address-form" method="post">
              {% csrf_token %}
              <div class="form-group">
                <div>{{form.country}}</div>
                <div>{{form.complete_name}}</div>
                <div>{{form.phone_number}}</div>
                <div>{{form.adress}}</div>
                <div>{{form.detail}}</div>
                <div>{{form.postal_code}}</div>
                <div>{{form.city}}</div>
              </div>
              <input class="btn btn-primary ml-3" type="submit" />
            </form>
          </div>
        </div>
        <div id="chosen-address" class="mt-4">
          <!-- afficher l'adresse choisie-->
        </div>
      </div>
    </div>
  </div>
</section>

{% endblock %} {% block script %}

<script>
  // stripe

  // address & pay

  function enablePaymentButton() {
    cardButton.disabled = false;
  }

  // address choice

  const chosenAddressDiv = document.getElementById("chosen-address");

  // Gestion des boutons "Choisir" (code précédent)
  document.addEventListener("DOMContentLoaded", function () {
    const addressButtons = document.querySelectorAll(".select-address");
    addressButtons.forEach((button) => {
      button.addEventListener("click", (e) => {
        const addressId = e.target.dataset.addressId;
        const addressDiv = e.target.closest("tr").querySelector("div");
        chosenAddressDiv.innerHTML = `<h5 class="mb-2">Adresse choisie :</h5>${addressDiv.innerHTML}`;
        // Ajoutez cette ligne pour stocker l'ID de l'adresse dans un attribut data
        chosenAddressDiv.dataset.addressId = addressId;
        enablePaymentButton();
      });
    });

    const newAddressForm = document.getElementById("new-address-form");
    const csrfToken = document.querySelector(
      "[name=csrfmiddlewaretoken]"
    ).value;

    newAddressForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(newAddressForm);
      const response = await fetch("{% url 'checkout_n' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
        },
        body: formData,
      });

      if (response.ok) {
        const address = await response.json();
        chosenAddressDiv.innerHTML = `<h5 class="mb-2">Adresse choisie :</h5>${address.html}`;
        // Ajoutez cette ligne pour stocker l'ID de l'adresse dans un attribut data
        chosenAddressDiv.dataset.addressId = address.address_id;
        newAddressForm.reset();
        enablePaymentButton();
      } else {
        // Gérer les erreurs de soumission du formulaire ici
        alert(
          "Erreur lors de la soumission de la nouvelle adresse. Veuillez réessayer."
        );
      }
    });
  });
</script>
<script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
{% endblock %}
